<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layouts/default.html}"
      layout:fragment="Content">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" defer>
	const formatter = new Intl.NumberFormat('ko-KR');
	let myChart = null;
	
	const backgroundColors = [
		'#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF',
		'#BDB2FF', '#FFC6FF', '#D4C1EC', '#F4978E', '#FBC4AB', '#80CED7'
	];

	$(function() {
		fn_getCategoryMonthlyAmount();		
	});
    
	function fn_getCategoryMonthlyAmount() {
		sendData = {
				year: $('#select-year').val(),
				month: $('#select-month').val()
		}
		axios({
			method: 'POST',
			url: '/hoit/accountBook/getCategoryMonthlyAmount.do',
			data: sendData
		})
		.then(res => {
			let html = '';
			let labels = [];
			let data = [];
			
			let totalAmount = res.data.reduce((acc, item) => acc + item.TOTAL, 0);
			
			res.data.forEach(function(item, index) {
				let category = item.CATEGORY_NM;
				let amount = item.TOTAL;
				let color = backgroundColors[index % backgroundColors.length];
				let percentage = (totalAmount > 0) ? ((amount / totalAmount) * 100).toFixed(1) : 0;
				
				html += `
					<div class="list-group-item border-0 px-4 py-3">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<div class="d-flex align-items-center">
								<span class="d-inline-block rounded-circle me-2" style="width: 12px; height: 12px; background-color: ${color};"></span>
								<span class="fw-bold text-dark">${category}</span>
							</div>
							<div class="text-end">
								<span class="fw-bold">${formatter.format(amount)}원</span>
								<span class="text-muted small ms-1">(${percentage}%)</span>
							</div>
						</div>
						<div class="progress" style="height: 6px; background-color: #f0f0f0;">
							<div class="progress-bar" role="progressbar" style="width: ${percentage}%; background-color: ${color}; border-radius: 10px;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
						</div>
					</div>`;
				
				labels.push(category);
				data.push(amount);
			});
			
			$('#monthly-data').html(html);
			fn_drawChart(labels, data, totalAmount);
		})
		.catch(e => {
			console.log(e);
		})
	}
	
	function fn_drawChart(labels, data, totalAmount) {
		const ctx = document.getElementById('myChart').getContext('2d');
		
		if (myChart) {
			myChart.destroy();
		}
		
		myChart = new Chart(ctx, {
			type: 'doughnut',
			data: {
				labels: labels,
				datasets: [{
					label: '카테고리별 합계',
					data: data,
					backgroundColor: backgroundColors,
					borderWidth: 1
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				cutout: '60%',
				plugins: {
					legend: {
						position: 'bottom',
					}
				}
			},
			plugins: [{
				id: 'textCenter',
				beforeDraw: function(chart) {
					var width = chart.width,
						height = chart.height,
						ctx = chart.ctx;

					ctx.restore();
					var fontSize = (Math.min(width, height) / 200).toFixed(2);
					ctx.font = "bold " + fontSize + "em sans-serif";
					ctx.textBaseline = "middle";
					ctx.fillStyle = "#333";
					
					var text = formatter.format(totalAmount) + "원";
					
					var textWidth = ctx.measureText(text).width;
					var holeSize = Math.min(width, height) * 0.5;
					if (textWidth > holeSize) {
						fontSize = (fontSize * (holeSize / textWidth)).toFixed(2);
						ctx.font = "bold " + fontSize + "em sans-serif";
					}
					
					var textX = Math.round((width - ctx.measureText(text).width) / 2),
						textY = height / 2;
					ctx.fillText(text, textX, textY);
					ctx.save();
				}
			}]
		});
	}
</script>
<body>
    <h2 class="text-center fw-bold mb-4" style="margin-top: 50px;">지출 통계</h2>
    <div class="container" style="max-width: 600px;">
    	<div class="row justify-content-center mb-4">
			<div class="col-auto">
				<div class="input-group">
			    	<select class="form-select border-0 bg-light fw-bold" id="select-year" style="cursor: pointer;">
						<option value="2026" selected>2026</option>
						<option value="2027">2027</option>
					</select>
					<select class="form-select border-0 bg-light fw-bold" id="select-month" style="cursor: pointer;">
						<option value="" selected>전체</option>
						<option value="01">1월</option>
						<option value="02">2월</option>
						<option value="03">3월</option>
						<option value="04">4월</option>
						<option value="05">5월</option>
						<option value="06">6월</option>
						<option value="07">7월</option>
						<option value="08">8월</option>
						<option value="09">9월</option>
						<option value="10">10월</option>
						<option value="11">11월</option>
						<option value="12">12월</option>
					</select>
				</div>
			</div>
		</div>
		
		<div class="card shadow-sm border-0 mb-4 rounded-4">
			<div class="card-body p-4">
				<div style="height: 300px; position: relative;">
					<canvas id="myChart"></canvas>
				</div>
			</div>
		</div>
		
		<div class="card shadow-sm border-0 rounded-4 mb-5">
			<div class="card-header bg-white border-0 pt-4 px-4 pb-0">
				<h5 class="fw-bold mb-0">상세 내역</h5>
			</div>
			<div id="monthly-data" class="card-body p-0 list-group list-group-flush rounded-bottom-4 py-2">
			</div>
		</div>
		
    </div>
	<script th:inline="javascript">
		$('#select-year, #select-month').change(function() {
			fn_getCategoryMonthlyAmount();
		})
	</script>
</body>
</html>